---
name: Deploy

# yamllint disable-line rule:truthy
on:
  release:
    types:
      - published
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types:
      - completed

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      dispatch: ${{ steps.set-output.outputs.dispatch }}
    steps:
      - name: ðŸ” Load 1Password secrets
        id: load-op
        uses: 1password/load-secrets-action@fdb192f5dcc59450a0ff90212092dac8865d9322
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          DISPATCH: "op://CI/Github Token/Anmeldedaten"

      - name: Set job output from KEY
        id: set-output
        run: |
          echo "dispatch=${DISPATCH}" >> $GITHUB_OUTPUT
  workflows:
    needs: prepare
    uses: homeassistant-apps/workflows/.github/workflows/addon-deploy.yaml@main
    secrets:
      DISPATCH_TOKEN: ${{ needs.prepare.outputs.dispatch }}
